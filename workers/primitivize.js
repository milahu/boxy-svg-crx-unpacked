let t={shapesType:["triangles"],shapesNumber:40,shapesAlpha:.7,autoAdjustShapesAlpha:!0,workingSize:128,backgroundColor:"#ffffff",shapesPerIteration:100,maxMutations:16,seed:100,overflow:"visible",renderAs:"paths",geometryPrecision:3,transformPrecision:6},i=null;self.addEventListener("message",(async l=>{let o=(await import("/modules/seed-random/seed-random.js")).default,[c,M]=l.data;M=e(t,M),i=new f(c,M,o);let{geometryPrecision:w,transformPrecision:m}=M;self.postMessage([0,`<svg viewBox="0 0 ${c.width} ${c.height}">`]),i.onStep=t=>{let e=i.getProgress(),l=`style="fill: ${s(t.color[0],t.color[1],t.color[2],t.alpha)};"`,o="";if(t.shape instanceof $){let e=t.shape.points.map((([t,e])=>new DOMPoint(t*i.scale,e*i.scale)));if("cut"===M.overflow){let t=new DOMRect(0,0,c.width,c.height);e=u(t,e),e=e.map((({x:t,y:i})=>new DOMPoint(n(t,w),n(i,w))))}let[s,...h]=e;o+=`<path ${`d="M ${s.x} ${s.y} `+h.map((({x:t,y:i})=>`L ${t} ${i}`)).join(" ")+' Z"'} ${l}></path>`}else if(t.shape instanceof p){let e=t.shape.bbox.left*i.scale,s=t.shape.bbox.top*i.scale,f=t.shape.bbox.width*i.scale,$=t.shape.bbox.height*i.scale,p=null;if(0!==t.shape.angle){let i=new DOMPoint(e+f/2,s+$/2);p=new DOMMatrix,p.translateSelf(i.x,i.y),p.rotateSelf(r(t.shape.angle)),p.translateSelf(-i.x,-i.y)}if("shapes"===M.renderAs){e=n(e,w),s=n(s,w),f=n(f,w),$=n($,w);let t="";p&&(t='transform="'+h(a(p,m))+'"'),o=`<rect x="${e}" y="${s}" width="${f}" height="${$}" ${t} ${l}></rect>`}else if("paths"===M.renderAs)if("visible"===M.overflow){let t='d="'+[["M",e,s],["H",e+f],["V",s+$],["H",e],["V",s],["Z"]].map((t=>t.join(" "))).join(" ")+'"',i="";p&&(i='transform="'+h(a(p,m))+'"'),o+=`<path ${t} ${i} ${l}></path>`}else if("cut"===M.overflow){let t=new DOMRect(0,0,c.width,c.height),i=[new DOMPoint(e,s),new DOMPoint(e+f,s),new DOMPoint(e+f,s+$),new DOMPoint(e,s+$)];p&&(i=i.map((t=>t.matrixTransform(p)))),i=u(t,i),i=i.map((({x:t,y:i})=>new DOMPoint(n(t,w),n(i,w))));let[h,...r]=i,a=`d="M ${h.x} ${h.y} `+r.map((({x:t,y:i})=>`L ${t} ${i}`)).join(" ")+' Z"';o+=`<path ${a} ${l}></path>`}}self.postMessage([e,o])},i.onEnd=t=>{self.postMessage([1,"</svg>"])},i.start()}));let e=(t,i)=>{let e={};for(let[s,h]of Object.entries(t))e[s]=void 0!==i[s]?i[s]:t[s];return e},s=(t,i,e,s)=>{let h=t=>{let i=t.toString(16);return 1==i.length?"0"+i:i};return 1===s?"#"+h(t)+h(i)+h(e):`rgba(${t},${i},${e},${s=n(s,2)})`},h=t=>`matrix(${t.a}, ${t.b}, ${t.c}, ${t.d}, ${t.e}, ${t.f})`,r=t=>t*(180/Math.PI),n=(t,i=0)=>{let e=Math.pow(10,i);return Math.round((t+Number.EPSILON)*e)/e},a=(t,i)=>t.is2D?new DOMMatrix([n(t.a,i),n(t.b,i),n(t.c,i),n(t.d,i),n(t.e,i),n(t.f,i)]):new DOMMatrix([n(t.m11,i),n(t.m12,i),n(t.m13,i),n(t.m14,i),n(t.m21,i),n(t.m22,i),n(t.m23,i),n(t.m24,i),n(t.m31,i),n(t.m32,i),n(t.m33,i),n(t.m34,i),n(t.m41,i),n(t.m42,i),n(t.m43,i),n(t.m44,i)]),l=(t,i,e)=>Math.max(i,Math.min(e,t)),o=(t,i)=>Math.sqrt(t/(3*i))/255,u=(t,i)=>{let e,s=(t,i,e,s)=>8&e?new DOMPoint(t.x+(i.x-t.x)*(s.height-t.y)/(i.y-t.y),s.height):4&e?new DOMPoint(t.x+(i.x-t.x)*(s.y-t.y)/(i.y-t.y),s.y):2&e?new DOMPoint(s.width,t.y+(i.y-t.y)*(s.width-t.x)/(i.x-t.x)):1&e?new DOMPoint(s.x,t.y+(i.y-t.y)*(s.x-t.x)/(i.x-t.x)):null,h=(t,i)=>{let e=0;return t.x<i.x?e|=1:t.x>i.width&&(e|=2),t.y<i.y?e|=4:t.y>i.height&&(e|=8),e};for(let r=1;r<=8;r*=2){let n=i[i.length-1],a=!(h(n,t)&r);e=[];for(let l=0;l<i.length;l++){let o=i[l],u=!(h(o,t)&r);u!==a&&e.push(s(n,o,r,t)),u&&e.push(o),n=o,a=u}if(!(i=e).length)break}return e};class f{constructor(t,i,e){let s=Math.max(t.width/i.workingSize,t.height/i.workingSize,1),h=t.width/s,r=t.height/s,n=new c(h,r,i.backgroundColor);n.context.drawImage(t,0,0,h,r),this.options=i,this.scale=s,this.getRandomNumber=new e(i.seed),this.onStep=()=>{},this.onEnd=()=>{},this.t=n.width,this.i=n.height,this.l=0,this.o=new M(n,new c(this.t,this.i,i.backgroundColor))}getProgress(){return n(this.l/this.options.shapesNumber,2)}getRandomNumber(){}getRandomPoint(t,i){return[~~(this.getRandomNumber()*t),~~(this.getRandomNumber()*i)]}start(){this.u()}async u(){let t=await this.M();t=await this.$(t),this.l+=1,t.distance<this.o.distance&&(this.o=t.apply(this.o),this.onStep(t)),this.p()}p(){this.l<this.options.shapesNumber?setTimeout((()=>this.u()),10):this.onEnd(this.o)}M(){let t=this.options.shapesPerIteration,i=null,e=[];for(let s=0;s<t;s+=1){let t,s=Math.floor(this.getRandomNumber()*this.options.shapesType.length),h=this.options.shapesType[s];"triangles"===h?t=$:"rectangles"===h&&(t=p);let r=new t(this.t,this.i,this);r.init();let n=new w(r,this).compute(this.o).then((t=>{(!i||t.distance<i.distance)&&(i=t)}));e.push(n)}return Promise.all(e).then((()=>i))}$(t){let i=this.options.maxMutations,e=0,s=null,h=t,r=new Promise((t=>s=t)),n=()=>{if(e>=i)return s(h);h.mutate().compute(this.o).then((t=>{t.distance<h.distance?(e=0,h=t):e+=1,n()}))};return n(),r}}class c extends OffscreenCanvas{constructor(t,i,e){super(t,i),this.context=this.getContext("2d"),this.m=null,e&&(this.context.fillStyle=e,this.context.fillRect(0,0,t,i))}drawStep(t){this.context.globalAlpha=t.alpha,this.context.fillStyle=`rgb(${t.color[0]}, ${t.color[1]}, ${t.color[2]})`,this.context.strokeStyle=`rgb(${t.color[0]}, ${t.color[1]}, ${t.color[2]})`,t.shape.render(this.context)}getImageData(){return this.m||(this.m=this.context.getImageData(0,0,this.width,this.height)),this.m}getDifference(t){let i=this.getImageData(),e=t.getImageData(),s=0;for(let t=0;t<i.data.length;t+=1)if(t%4!=3){let h=e.data[t]-i.data[t];s+=h*h}return s}getDistance(t){let i=this.getDifference(t);return o(i,this.width*this.height)}clone(){let t=new c(this.width,this.height);return t.context.drawImage(this,0,0),t}}class M{constructor(t,i,e=Infinity){this.sourceCanvas=t,this.destCanvas=i,this.distance=Infinity===e?t.getDistance(i):e}}class w{constructor(t,i){this.g=i,this.shape=t,this.alpha=this.g.options.shapesAlpha,this.color=[0,0,0],this.distance=Infinity}apply(t){let i=t.destCanvas.clone();return i.drawStep(this),new M(t.sourceCanvas,i,this.distance)}mutate(){let t=this.shape.mutate(),i=new w(t,this.g);if(this.g.options.autoAdjustShapesAlpha){let t=this.alpha+.08*(this.g.getRandomNumber()-.5);i.alpha=l(t,.1,1)}return i}compute(t){let i={shape:this.shape.rasterize(this.alpha).getImageData(),current:t.destCanvas.getImageData(),target:t.sourceCanvas.getImageData()},e=t.destCanvas.width*t.destCanvas.height,s=this.shape.bbox,h=this.P(s,i,this.alpha),r=this.D(s,i,h),n=((t,i)=>Math.pow(255*t,2)*(3*i))(t.distance,e);return this.color=[...h],this.distance=o(n+r,e),Promise.resolve(this)}D(t,i,e){let s,h,r,n,a,l,o,u,f,c,M,w,$,p,{shape:m,current:g,target:d}=i,P=m.data,y=g.data,D=d.data,O=m.width,b=m.height,x=g.width,I=g.height;var v=0;for(M=0;M<b;M+=1)if(p=M+t.top,!(p<0||p>=I))for(c=0;c<O;c+=1)$=t.left+c,$<0||$>=x||(f=4*(c+M*O),s=P[f+3],0!==s&&(w=4*($+p*x),s/=255,h=1-s,r=D[w]-y[w],n=D[w+1]-y[w+1],a=D[w+2]-y[w+2],l=D[w]-(e[0]*s+y[w]*h),u=D[w+1]-(e[1]*s+y[w+1]*h),o=D[w+2]-(e[2]*s+y[w+2]*h),v-=r*r+n*n+a*a,v+=l*l+u*u+o*o));return v}P(t,i,e){let s,h,r,n,a,o,{shape:u,current:f,target:c}=i,M=u.data,w=f.data,$=c.data,p=u.width,m=u.height,g=f.width,d=f.height,P=[0,0,0],y=0;for(r=0;r<m;r+=1)if(o=r+t.top,!(o<0||o>=d))for(h=0;h<p;h+=1)a=t.left+h,a<0||a>=g||(s=4*(h+r*p),0!==M[s+3]&&(n=4*(a+o*g),P[0]+=($[n]-w[n])/e+w[n],P[1]+=($[n+1]-w[n+1])/e+w[n+1],P[2]+=($[n+2]-w[n+2])/e+w[n+2],y+=1));return P.map((t=>~~(t/y))).map((t=>l(t,0,255)))}}class ${constructor(t,i,e){this.bbox={},this.w=t,this.h=i,this.count=3,this.g=e}init(){return this.points=this.O(),this.computeBBox(),this}render(t){t.beginPath(),this.points.forEach((([i,e],s)=>{s?t.lineTo(i,e):t.moveTo(i,e)})),t.closePath(),t.fill()}mutate(){let t=new $(0,0,this.g);t.points=this.points.map((t=>t.slice()));let i=Math.floor(this.g.getRandomNumber()*this.points.length),e=t.points[i],s=2*this.g.getRandomNumber()*Math.PI,h=20*this.g.getRandomNumber();return e[0]+=~~(h*Math.cos(s)),e[1]+=~~(h*Math.sin(s)),t.computeBBox()}computeBBox(){let t=[this.points.reduce(((t,i)=>Math.min(t,i[0])),Infinity),this.points.reduce(((t,i)=>Math.min(t,i[1])),Infinity)],i=[this.points.reduce(((t,i)=>Math.max(t,i[0])),-Infinity),this.points.reduce(((t,i)=>Math.max(t,i[1])),-Infinity)];return this.bbox={left:t[0],top:t[1],width:i[0]-t[0]||1,height:i[1]-t[1]||1},this}O(){let t=this.g.getRandomPoint(this.w,this.h),i=[t];for(let e=1;e<this.count;e+=1){let e=2*this.g.getRandomNumber()*Math.PI,s=20*this.g.getRandomNumber();i.push([t[0]+~~(s*Math.cos(e)),t[1]+~~(s*Math.sin(e))])}return i}rasterize(t){let i=new c(this.bbox.width,this.bbox.height),e=i.context;return e.fillStyle="#000",e.globalAlpha=t,e.translate(-this.bbox.left,-this.bbox.top),this.render(e),i}}class p{constructor(t,i,e){this.bbox={},this.w=t,this.h=i,this.angle=0,this.count=4,this.g=e}init(){return this.points=this.O(),this.computeBBox(),this}render(t){t.save();let i=((...t)=>{let i=t.reduce(((t,i)=>[t[0]+i[0],t[1]+i[1]]));return[i[0]/t.length,i[1]/t.length]})(this.points[0],this.points[2]);t.translate(i[0],i[1]),t.rotate(this.angle),t.translate(-i[0],-i[1]),t.beginPath(),this.points.forEach((([i,e],s)=>{s?t.lineTo(i,e):t.moveTo(i,e)})),t.closePath(),t.fill(),t.restore()}mutate(){let t=new p(0,0,this.g);t.points=this.points.map((t=>t.slice()));let i=~~(20*(this.g.getRandomNumber()-.5));switch(Math.floor(8*this.g.getRandomNumber())){case 0:t.points[0][0]+=i,t.points[3][0]+=i;break;case 1:t.points[0][1]+=i,t.points[1][1]+=i;break;case 2:t.points[1][0]+=i,t.points[2][0]+=i;break;case 3:t.points[2][1]+=i,t.points[3][1]+=i;break;case 4:case 5:case 6:case 7:t.angle=(i/20+.5)*Math.PI}return t.computeBBox()}computeBBox(){let t=[this.points.reduce(((t,i)=>Math.min(t,i[0])),Infinity),this.points.reduce(((t,i)=>Math.min(t,i[1])),Infinity)],i=[this.points.reduce(((t,i)=>Math.max(t,i[0])),-Infinity),this.points.reduce(((t,i)=>Math.max(t,i[1])),-Infinity)];return this.bbox={left:t[0],top:t[1],width:i[0]-t[0]||1,height:i[1]-t[1]||1},this}O(){let t=this.g.getRandomPoint(this.w,this.h),i=this.g.getRandomPoint(this.w,this.h),e=Math.min(t[0],i[0]),s=Math.max(t[0],i[0]),h=Math.min(t[1],i[1]),r=Math.max(t[1],i[1]);return[[e,h],[s,h],[s,r],[e,r]]}rasterize(t){let i=new c(this.bbox.width,this.bbox.height),e=i.context;return e.fillStyle="#000",e.globalAlpha=t,e.translate(-this.bbox.left,-this.bbox.top),this.render(e),i}}